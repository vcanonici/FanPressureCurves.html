<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Cooling Box Simulator — Volume-aware (responsive)</title>
<style>
  :root{
    --sidebar-min: 14rem;
    --sidebar-max: 34vw;
    --gutter: 0.6rem;
    --pad: clamp(0.5rem, 1.2vw, 0.9rem);
    --gap: clamp(0.4rem, 1vw, 0.9rem);
    --radius: 0.5rem;
    --accent: #0077cc;
    --muted: #666;
    --font-min: 0.9rem;
    --font-preferred: 1.0vw;
    --font-max: 1.15rem;
  }
  html { font-size: clamp(var(--font-min), var(--font-preferred), var(--font-max)); }
  body { margin:0; font-family:Inter, Roboto, Arial, sans-serif; color:#111; background:#fafafa; }
  header { display:flex; gap:0.6rem; align-items:center; padding:0.6rem 1rem; }
  .stage { height: calc(100vh - 3rem); display:grid; grid-template-columns: minmax(var(--sidebar-min), var(--sidebar-max)) var(--gutter) 1fr; gap:0; padding: calc(var(--pad)); box-sizing:border-box; }
  .panel { background:#fff; border-radius: calc(var(--radius)); padding: calc(var(--pad)); box-sizing:border-box; box-shadow: 0 0 0 1px rgba(0,0,0,0.03) inset; overflow:auto; min-height:0; }
  .left { display:flex; flex-direction:column; gap:var(--gap); }
  .resizer { width: clamp(0.4rem, 0.8vw, 1rem); background:linear-gradient(90deg,#eee,#ddd); cursor:col-resize; display:flex; align-items:center; justify-content:center; user-select:none; }
  .resizer .bar { width:0.35rem; height:50%; background:rgba(0,0,0,0.06); border-radius:0.3rem; }
  label { display:block; font-size:0.9em; color:var(--muted); margin-bottom:0.25rem; }
  input[type="text"], input[type="number"], select, button { width:100%; padding: calc(var(--pad) * 0.8); box-sizing:border-box; border-radius:6px; border:1px solid #e6e6e6; font-size:0.95em; background:#fff; }
  .small-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(8rem, 1fr)); gap:var(--gap); }
  .groups { display:flex; flex-direction:column; gap:calc(var(--gap) / 2); max-height: calc(40vh); overflow:auto; padding-right:4px; }
  .grp { display:grid; grid-template-columns: 1fr 6.5rem 6.5rem 4.5rem 3.2rem; gap:0.5rem; align-items:center; padding:0.5rem; background:#fbfbfb; border-radius:6px; border:1px solid #f0f0f0; }
  .curve-list { max-height: 26vh; overflow:auto; border-radius:6px; padding:0.4rem; background:#fff; border:1px solid #f0f0f0; }
  .frame-16-9 { width:100%; height:0; padding-top:56.25%; position:relative; border-radius:8px; overflow:hidden; background:linear-gradient(180deg,#ffffff,#fbfdff); box-shadow:0 6px 18px rgba(0,0,0,0.04); }
  canvas { position:absolute; left:0; top:0; width:100% !important; height:100% !important; }
  button.primary { background:var(--accent); color:white; border:0; padding:calc(var(--pad) * 0.8); border-radius:6px; cursor:pointer; font-weight:600; }
  button.ghost { background:transparent; border:1px solid #e6e6e6; color:var(--muted); }
  .muted { font-size:0.9em; color:var(--muted); }
  @media (max-width:900px){ .stage { grid-template-columns: minmax(12rem, 42vw) var(--gutter) 1fr; padding:0.6rem; } .grp { grid-template-columns: 1fr 5.5rem 5.5rem 4rem 3rem; } }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
<header>
  <strong style="font-size:1.05rem">Cooling Box Simulator — Volume-aware</strong>
  <span class="muted">Adjust cabinet dimensions or enter volume. Session/profile save & load supported.</span>
</header>

<div class="stage" id="stage">
  <div class="panel left" id="leftPanel">
    <div style="display:flex;flex-direction:column;gap:var(--gap)">

      <div>
        <label>Box resistance baseline R (mmH₂O / CFM²)</label>
        <input id="R" type="number" step="1e-6" value="0.00001" />
        <div class="muted" style="margin-top:0.25rem">Base resistance used before volume scaling. Tweak as needed.</div>
      </div>

      <div class="small-grid">
        <div>
          <label>Temperature min (°C)</label>
          <input id="tmin" type="number" value="25" />
        </div>
        <div>
          <label>Temperature max (°C)</label>
          <input id="tmax" type="number" value="95" />
        </div>
        <div>
          <label>Steps (points)</label>
          <input id="steps" type="number" value="140" min="10" max="1000" />
        </div>
      </div>

      <hr style="border:none;border-top:1px solid #f0f0f0;margin:0.4rem 0" />

      <div>
        <label>Cabinet size (choose either dimensions or volume)</label>
        <div class="small-grid">
          <div>
            <label>Width (cm)</label>
            <input id="box_w" type="number" min="0" step="0.1" placeholder="e.g. 40" />
          </div>
          <div>
            <label>Height (cm)</label>
            <input id="box_h" type="number" min="0" step="0.1" placeholder="e.g. 50" />
          </div>
          <div>
            <label>Depth (cm)</label>
            <input id="box_d" type="number" min="0" step="0.1" placeholder="e.g. 50" />
          </div>
        </div>
        <div style="margin-top:0.5rem">
          <label>Or enter Volume directly (liters)</label>
          <input id="box_vol_l" type="number" min="0" step="0.1" placeholder="e.g. 50 (liters)" />
        </div>
        <div style="display:flex;gap:0.5rem;margin-top:0.5rem;align-items:center">
          <div style="flex:1">
            <label>Computed Volume</label>
            <input id="computed_volume" type="text" readonly />
            <div class="muted" style="margin-top:0.25rem">Volume is shown in liters and cubic meters.</div>
          </div>
          <div style="width:9rem">
            <label>Leakage factor</label>
            <input id="leak_factor" type="number" step="0.1" value="1" />
            <div class="muted" style="font-size:0.8em;margin-top:0.15rem">Multiply effective R by this factor (1 = default leakage).</div>
          </div>
        </div>

        <div class="muted" style="margin-top:0.5rem">
          Volume scaling model: effective resistance R_eff = R_base * (V_ref / V_box_m3) * leakage_factor.
          Default reference volume V_ref = 0.05 m³ (50 L). Larger cabinets reduce effective resistance proportionally.
          This is an approximation for quick sensitivity analysis, not a CFD result.
        </div>
      </div>

      <hr style="border:none;border-top:1px solid #f0f0f0;margin:0.4rem 0" />

      <div>
        <label>Add / manage groups (each group = N fans in parallel)</label>
        <div style="display:grid;grid-template-columns: 1fr 7rem; gap:var(--gap)">
          <input id="new_name" placeholder="Group name (e.g. P12 Pro)" />
          <button id="addGroup" class="primary">Add</button>
        </div>
        <div class="small-grid" style="margin-top:0.4rem">
          <input id="new_n" type="number" value="1" />
          <input id="new_q" type="number" value="77" step="0.1" />
          <select id="new_role"><option value="in">Intake</option><option value="out">Exhaust</option></select>
        </div>
        <div class="muted" style="margin-top:0.25rem">Enter count, free-air CFM per fan, and role.</div>
        <div class="groups" id="groupsList"></div>
      </div>

      <hr style="border:none;border-top:1px solid #f0f0f0;margin:0.4rem 0" />

      <div>
        <label>Per-group temperature → speed curve (selected group)</label>
        <div style="display:grid;grid-template-columns: 1fr 6.5rem; gap:var(--gap)">
          <input id="cp_temp" type="number" placeholder="Temp °C" />
          <input id="cp_pct" type="number" placeholder="% (0-100)" />
        </div>
        <div style="display:flex;gap:var(--gap);margin-top:0.5rem">
          <button id="cp_add" class="primary" style="flex:1">Add point</button>
          <button id="clear_curve" class="ghost" style="flex:0 0 auto">Clear</button>
        </div>
        <div class="curve-list" id="curveList" style="margin-top:0.5rem"></div>
      </div>

      <div style="display:flex;gap:var(--gap);flex-wrap:wrap;margin-top:0.6rem">
        <button id="plot" class="primary">Plot</button>
        <button id="exportCsv" class="ghost">Export CSV</button>
        <button id="saveGroupProfile" class="ghost">Save group</button>
        <button id="loadProfile" class="ghost">Load profile</button>
        <button id="saveSession" class="ghost">Save session</button>
        <button id="loadSession" class="ghost">Load session</button>
        <input id="fileLoader" type="file" accept=".json" style="display:none" />
      </div>

    </div>
  </div>

  <div class="resizer" id="resizer" title="Drag to resize sidebar"><div class="bar" aria-hidden="true"></div></div>

  <div class="panel" id="rightPanel">
    <div class="frame-16-9"><canvas id="chart" aria-label="Flow and pressure chart"></canvas></div>
    <div style="display:flex;justify-content:space-between;margin-top:0.6rem;font-size:0.95rem">
      <div class="muted">X: CPU temperature (°C) • Left: Flow (CFM) • Right: Pressure (mmH₂O)</div>
      <div class="muted">Equilibrium when Qin = Qout</div>
    </div>
  </div>
</div>

<script>
/* Volume-aware Cooling Box Simulator
   - R_eff = R_base * (V_ref / V_box_m3) * leakage_factor
   - V_ref default = 0.05 m^3 (50 L). Change in code if desired.
   - Save/load uses JSON files (profiles/sessions).
*/

/* Helpers */
function linQ(Qfree, s){ return Qfree * s; }
function sign(x){ return x>0?1:(x<0?-1:0); }
function lerp(x0,y0,x1,y1,x){ if(x1===x0) return y0; return y0 + (y1-y0)*( (x - x0)/(x1-x0) ); }
function uid(){ return Math.random().toString(36).slice(2,9); }

/* State */
let groups = []; // {id,name,role,n,Qfree,curve:[{t,pct}]}
let selected = null;
let chart = null;

/* DOM refs */
const groupsList = document.getElementById('groupsList');
const curveList = document.getElementById('curveList');
const fileLoader = document.getElementById('fileLoader');

/* Volume logic */
const V_REF_M3 = 0.05; // reference volume in m^3 (50 liters)

function computeBoxVolumeFromDims(){
  const w = Number(document.getElementById('box_w').value) || 0;
  const h = Number(document.getElementById('box_h').value) || 0;
  const d = Number(document.getElementById('box_d').value) || 0;
  if(w>0 && h>0 && d>0){
    const vol_m3 = (w/100) * (h/100) * (d/100); // convert cm -> m
    return vol_m3;
  }
  return 0;
}
function getBoxVolume_m3(){
  const vol_l = Number(document.getElementById('box_vol_l').value) || 0;
  if(vol_l > 0) return vol_l / 1000.0;
  const from_dims = computeBoxVolumeFromDims();
  if(from_dims > 0) return from_dims;
  return V_REF_M3; // fallback to reference if none provided
}
function updateComputedVolumeDisplay(){
  const v_m3 = getBoxVolume_m3();
  const v_l = v_m3 * 1000;
  document.getElementById('computed_volume').value = `${v_l.toFixed(2)} L — ${v_m3.toFixed(4)} m³`;
}

/* Wire up dimension-volume mutual update */
document.getElementById('box_w').addEventListener('input', ()=> { document.getElementById('box_vol_l').value = ''; updateComputedVolumeDisplay(); });
document.getElementById('box_h').addEventListener('input', ()=> { document.getElementById('box_vol_l').value = ''; updateComputedVolumeDisplay(); });
document.getElementById('box_d').addEventListener('input', ()=> { document.getElementById('box_vol_l').value = ''; updateComputedVolumeDisplay(); });
document.getElementById('box_vol_l').addEventListener('input', ()=> { if(Number(document.getElementById('box_vol_l').value)>0){ document.getElementById('box_w').value=''; document.getElementById('box_h').value=''; document.getElementById('box_d').value=''; } updateComputedVolumeDisplay(); });

/* Render groups UI */
function renderGroups(){
  groupsList.innerHTML = '';
  groups.forEach(g=>{
    const el = document.createElement('div');
    el.className = 'grp';
    el.dataset.id = g.id;
    el.innerHTML = `
      <div style="display:flex;flex-direction:column;gap:0.15rem">
        <strong style="font-size:0.98em">${g.name}</strong>
        <span style="font-size:0.86em;color:#666">${g.role==='in'?'Intake':'Exhaust'} · x${g.n} · ${g.Qfree} CFM</span>
      </div>
      <div><input data-id="${g.id}" class="g_n" type="number" value="${g.n}" /></div>
      <div><input data-id="${g.id}" class="g_q" type="number" value="${g.Qfree}" step="0.1" /></div>
      <div>
        <select data-id="${g.id}" class="g_role">
          <option value="in" ${g.role==='in'?'selected':''}>Intake</option>
          <option value="out" ${g.role==='out'?'selected':''}>Exhaust</option>
        </select>
      </div>
      <div style="display:flex;gap:6px">
        <button data-id="${g.id}" class="sel" title="Select">Sel</button>
        <button data-id="${g.id}" class="dup" title="Duplicate">⤷</button>
        <button data-id="${g.id}" class="del" title="Remove">✕</button>
      </div>
    `;
    groupsList.appendChild(el);

    el.querySelector('.sel').addEventListener('click', ()=>{ selected = g.id; renderCurveEditor(); highlightSelected(); });
    el.querySelector('.dup').addEventListener('click', ()=>{ const copy = JSON.parse(JSON.stringify(g)); copy.id = uid(); groups.push(copy); renderGroups(); });
    el.querySelector('.del').addEventListener('click', ()=>{ groups = groups.filter(x=>x.id!==g.id); if(selected===g.id) selected=null; renderGroups(); renderCurveEditor(); });
    el.querySelector('.g_n').addEventListener('change', (e)=>{ g.n = Number(e.target.value)||0; renderGroups(); });
    el.querySelector('.g_q').addEventListener('change', (e)=>{ g.Qfree = Number(e.target.value)||0; renderGroups(); });
    el.querySelector('.g_role').addEventListener('change', (e)=>{ g.role = e.target.value; renderGroups(); });
  });
  highlightSelected();
}
function highlightSelected(){
  groupsList.querySelectorAll('.grp').forEach(el=> el.style.outline = (el.dataset.id===selected) ? '2px solid rgba(0,120,200,0.08)' : 'none');
}

/* Curve editor */
function renderCurveEditor(){
  curveList.innerHTML = '';
  const g = groups.find(x=>x.id===selected);
  if(!g){ curveList.innerHTML = '<div class="muted">Select a group to edit its temperature→speed curve.</div>'; return; }
  const header = document.createElement('div'); header.className='muted'; header.style.marginBottom='0.25rem';
  header.textContent = `Curve for: ${g.name} · ${g.role} · x${g.n} · ${g.Qfree} CFM`;
  curveList.appendChild(header);
  g.curve = g.curve || [];
  g.curve.sort((a,b)=>a.t-b.t);
  g.curve.forEach((p, i)=>{
    const row = document.createElement('div');
    row.style.display='flex'; row.style.justifyContent='space-between'; row.style.padding='0.35rem 0.4rem'; row.style.borderBottom='1px solid #f5f5f5';
    row.innerHTML = `<div style="font-size:0.95em">T=${p.t}°C → ${p.pct}%</div><div><button data-i="${i}" class="del">Remove</button></div>`;
    curveList.appendChild(row);
    row.querySelector('.del').addEventListener('click', ()=>{ g.curve.splice(i,1); renderCurveEditor(); });
  });
}

/* Add group and curve points */
document.getElementById('addGroup').addEventListener('click', ()=>{
  const name = document.getElementById('new_name').value.trim() || 'Group';
  const n = Number(document.getElementById('new_n').value) || 1;
  const q = Number(document.getElementById('new_q').value) || 0;
  const role = document.getElementById('new_role').value;
  const g = { id: uid(), name, role, n, Qfree:q, curve: [] };
  groups.push(g); selected = g.id; renderGroups(); renderCurveEditor();
});
document.getElementById('cp_add').addEventListener('click', ()=>{
  const t = Number(document.getElementById('cp_temp').value);
  const pct = Number(document.getElementById('cp_pct').value);
  if(isNaN(t) || isNaN(pct)){ alert('Specify temperature and percentage'); return; }
  const g = groups.find(x=>x.id===selected);
  if(!g){ alert('Select a group first'); return; }
  g.curve = g.curve || []; g.curve.push({ t: t, pct: pct }); renderCurveEditor();
});
document.getElementById('clear_curve').addEventListener('click', ()=>{ const g = groups.find(x=>x.id===selected); if(g){ g.curve = []; renderCurveEditor(); } });

/* Interpolate per-group temperature -> speed fraction (0..1) */
function tempToSpeedFractionGroup(T, g){
  if(!g || !g.curve || g.curve.length===0) return 0;
  const pts = g.curve.slice().sort((a,b)=>a.t-b.t);
  if(T <= pts[0].t){
    if(pts.length===1) return Math.max(0,Math.min(1, pts[0].pct/100));
    return Math.max(0,Math.min(1, lerp(pts[0].t, pts[0].pct/100, pts[1].t, pts[1].pct/100, T)));
  }
  if(T >= pts[pts.length-1].t){
    if(pts.length===1) return Math.max(0,Math.min(1, pts[0].pct/100));
    const n=pts.length;
    return Math.max(0,Math.min(1, lerp(pts[n-2].t, pts[n-2].pct/100, pts[n-1].t, pts[n-1].pct/100, T)));
  }
  for(let i=0;i<pts.length-1;i++){
    if(T >= pts[i].t && T <= pts[i+1].t) return Math.max(0,Math.min(1, lerp(pts[i].t, pts[i].pct/100, pts[i+1].t, pts[i+1].pct/100, T)));
  }
  return 0;
}

/* Compute flows and scaled pressure */
function computeAll(){
  updateComputedVolumeDisplay();
  const R_base = Number(document.getElementById('R').value) || 1e-5;
  const leak = Number(document.getElementById('leak_factor').value) || 1;
  const tmin = Number(document.getElementById('tmin').value) || 25;
  const tmax = Number(document.getElementById('tmax').value) || 95;
  const steps = Number(document.getElementById('steps').value) || 140;
  const V_box_m3 = getBoxVolume_m3();
  const R_eff = R_base * (V_REF_M3 / Math.max(V_box_m3, 1e-6)) * leak; // avoid zero division

  const temps = Array.from({length:steps}, (_,i) => tmin + (tmax - tmin) * (i/(steps-1)) );
  const results = temps.map(T=>{
    const groupQs = groups.map(g=>{
      const s = tempToSpeedFractionGroup(T, g);
      return { id:g.id, name:g.name, role:g.role, n:g.n, Q: g.n * linQ(g.Qfree, s), speed_pct: s*100 };
    });
    const Qin = groupQs.filter(x=>x.role==='in').reduce((a,b)=>a+b.Q,0);
    const Qout = groupQs.filter(x=>x.role==='out').reduce((a,b)=>a+b.Q,0);
    const Qnet = Qin - Qout;
    // Use R_eff (volume-scaled) to compute box pressure
    const Pbox = Number(R_eff) * (Qnet*Qnet) * sign(Qnet);
    return { T, groupQs, Qin, Qout, Qnet, Pbox, R_eff, V_box_m3 };
  });
  return { temps, results, R_eff, V_box_m3 };
}

/* Plot using Chart.js */
function drawChart(){
  if(groups.length===0){ alert('No groups defined.'); return; }
  const dataPack = computeAll();
  const labels = dataPack.temps.map(t=> Math.round(t*10)/10 );
  const datasets = [];
  groups.forEach((g, idx)=>{
    const vals = dataPack.results.map(r => r.groupQs.find(x=>x.id===g.id).Q );
    const hue = (idx*48) % 360;
    const col = `hsl(${hue} 70% 40%)`;
    datasets.push({ label:(g.role==='in'?'Intake: ':'Exhaust: ')+g.name+' x'+g.n, data: vals, borderColor: col, backgroundColor: col.replace('40%)','10%)'), yAxisID:'y', pointRadius:0, tension:0.15 });
  });
  const pos = dataPack.results.map(r => Math.max(r.Pbox,0));
  const neg = dataPack.results.map(r => Math.min(r.Pbox,0));
  datasets.push({ label:'Positive pressure (mmH₂O)', data: pos, borderColor:'rgba(0,160,80,0.9)', backgroundColor:'rgba(102,255,153,0.25)', fill:true, yAxisID:'y2', pointRadius:0, tension:0.1 });
  datasets.push({ label:'Negative pressure (mmH₂O)', data: neg, borderColor:'rgba(255,80,80,0.9)', backgroundColor:'rgba(255,153,153,0.25)', fill:true, yAxisID:'y2', pointRadius:0, tension:0.1 });
  datasets.push({ label:'Box pressure (mmH₂O)', data: dataPack.results.map(r=>r.Pbox), borderColor:'rgba(0,0,0,1)', backgroundColor:'rgba(0,0,0,0)', yAxisID:'y2', pointRadius:0, tension:0.2, borderWidth:2 });

  // footer subtitle with effective R and volume
  const subtitle = `Effective R = ${dataPack.R_eff.toExponential(3)} mmH₂O/CFM² · Box volume = ${(dataPack.V_box_m3*1000).toFixed(2)} L`;

  const ctx = document.getElementById('chart').getContext('2d');
  if(chart) chart.destroy();
  chart = new Chart(ctx, {
    type:'line',
    data:{ labels, datasets },
    options:{
      maintainAspectRatio:false,
      interaction:{mode:'index',intersect:false},
      plugins:{ title:{display:true,text:'Flow (CFM) and Box Pressure (mmH₂O) vs CPU Temperature (°C)'}, subtitle:{display:true,text:subtitle} , legend:{position:'top'} },
      scales:{
        x:{ title:{display:true,text:'CPU Temperature (°C)'} },
        y:{ type:'linear', position:'left', title:{display:true,text:'Flow (CFM)'} },
        y2:{ type:'linear', position:'right', title:{display:true,text:'Pressure (mmH₂O)'}, grid:{drawOnChartArea:false} }
      }
    }
  });
  window.chart = chart;
}

/* CSV export (includes computed R_eff and volume for each row) */
document.getElementById('exportCsv').addEventListener('click', ()=>{
  if(groups.length===0){ alert('No groups.'); return; }
  const pack = computeAll();
  let csv = 'temp_C';
  groups.forEach(g=> csv += ',' + g.name.replace(/,/g,''));
  csv += ',Q_in,Q_out,Q_net,P_box_mmH2O,R_eff_mmH2O_per_CFM2,box_volume_L\n';
  pack.results.forEach(r=>{
    csv += r.T.toFixed(2);
    groups.forEach(g=>{
      const q = r.groupQs.find(x=>x.id===g.id).Q;
      csv += ',' + q.toFixed(6);
    });
    csv += ',' + r.Qin.toFixed(6) + ',' + r.Qout.toFixed(6) + ',' + r.Qnet.toFixed(6) + ',' + r.Pbox.toExponential(6) + ',' + r.R_eff.toExponential(6) + ',' + (r.V_box_m3*1000).toFixed(3) + '\n';
  });
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='volume_pressure_flow.csv'; a.click(); URL.revokeObjectURL(url);
});

/* Profiles and sessions (JSON) */
document.getElementById('saveGroupProfile').addEventListener('click', ()=>{
  const g = groups.find(x=>x.id===selected);
  if(!g){ alert('Select a group.'); return; }
  const payload = { type:'group', version:1, group: g };
  const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
  const filename = (g.name.replace(/\s+/g,'_') || 'group') + '_profile.json';
  const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url);
});
document.getElementById('loadProfile').addEventListener('click', ()=> fileLoader.click());
fileLoader.addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  try{
    const txt = await f.text(); const parsed = JSON.parse(txt);
    if(parsed.type === 'group' && parsed.group){ const g = parsed.group; g.id = uid(); groups.push(g); renderGroups(); alert('Group profile imported.'); }
    else if(parsed.type === 'session' && Array.isArray(parsed.groups)){ groups = parsed.groups.map(g=> ({...g, id: uid()})); if(parsed.meta){ document.getElementById('R').value = parsed.meta.R; document.getElementById('tmin').value = parsed.meta.tmin; document.getElementById('tmax').value = parsed.meta.tmax; document.getElementById('steps').value = parsed.meta.steps; document.getElementById('box_vol_l').value = parsed.meta.box_vol_l || ''; document.getElementById('box_w').value = parsed.meta.box_w || ''; document.getElementById('box_h').value = parsed.meta.box_h || ''; document.getElementById('box_d').value = parsed.meta.box_d || ''; document.getElementById('leak_factor').value = parsed.meta.leak_factor || 1; } selected = groups.length?groups[0].id:null; renderGroups(); renderCurveEditor(); alert('Session loaded.'); }
    else if(Array.isArray(parsed)){ parsed.forEach(pg=>{ if(pg.name){ pg.id = uid(); groups.push(pg); }}); renderGroups(); alert('List imported.'); }
    else alert('JSON file not recognized.');
  } catch(err){ alert('Error reading file: ' + err.message); }
  fileLoader.value = '';
});

/* Save / Load session */
document.getElementById('saveSession').addEventListener('click', ()=>{
  const payload = { type:'session', version:1, meta:{ R: Number(document.getElementById('R').value)||1e-5, tmin: Number(document.getElementById('tmin').value)||25, tmax: Number(document.getElementById('tmax').value)||95, steps: Number(document.getElementById('steps').value)||140, box_vol_l: Number(document.getElementById('box_vol_l').value)||'', box_w: Number(document.getElementById('box_w').value)||'', box_h: Number(document.getElementById('box_h').value)||'', box_d: Number(document.getElementById('box_d').value)||'', leak_factor: Number(document.getElementById('leak_factor').value)||1 }, groups: groups };
  const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
  const filename = 'cooler_session_' + (new Date()).toISOString().replace(/[:.]/g,'-') + '.json';
  const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url);
});
document.getElementById('loadSession').addEventListener('click', ()=> fileLoader.click());

/* Resizer */
(function(){
  const stage = document.getElementById('stage');
  const resizer = document.getElementById('resizer');
  const left = document.getElementById('leftPanel');
  let dragging=false, startX=0, startWidth=0;
  resizer.addEventListener('mousedown',(e)=>{ dragging=true; startX=e.clientX; startWidth=left.getBoundingClientRect().width; document.body.style.userSelect='none'; });
  window.addEventListener('mousemove',(e)=>{ if(!dragging) return; const dx=e.clientX-startX; let newW = startWidth+dx; const minW = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--sidebar-min')) || 224; const maxW = Math.max((parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--sidebar-max'))|| window.innerWidth*0.34), window.innerWidth-280); if(newW<minW) newW=minW; if(newW>maxW) newW=maxW; stage.style.gridTemplateColumns = `minmax(${getComputedStyle(document.documentElement).getPropertyValue('--sidebar-min')}, ${newW}px) ${getComputedStyle(document.documentElement).getPropertyValue('--gutter')} 1fr`; if(window.chart && window.chart.resize) window.chart.resize(); });
  window.addEventListener('mouseup',()=>{ if(dragging){ dragging=false; document.body.style.userSelect=''; } });
  resizer.addEventListener('dblclick', ()=>{ stage.style.gridTemplateColumns = `minmax(var(--sidebar-min), var(--sidebar-max)) var(--gutter) 1fr`; if(window.chart && window.chart.resize) window.chart.resize(); });
})();

/* Plot button */
document.getElementById('plot').addEventListener('click', ()=> { updateComputedVolumeDisplay(); drawChart(); });

/* Initialize empty UI */
renderGroups();
renderCurveEditor();
updateComputedVolumeDisplay();
</script>
</body>
</html>
